#!/usr/bin/env bash
# Optimize network settings for Tailscale VNC performance
# Enables UDP GRO forwarding for maximum throughput

set -euo pipefail

echo "ðŸŒ Optimizing network for Tailscale performance..."
echo ""

# Detect Tailscale's physical interface
PHYSICAL_IFACE=$(ip route show default | awk '/default/ {print $5; exit}')

if [[ -z "$PHYSICAL_IFACE" ]]; then
    echo "âŒ Could not detect network interface"
    exit 1
fi

echo "ðŸ“¡ Detected interface: $PHYSICAL_IFACE"
echo ""

# Check current UDP GRO forwarding status
CURRENT_GRO=$(sudo ethtool -k "$PHYSICAL_IFACE" | grep "rx-udp-gro-forwarding" | awk '{print $2}')
echo "Current UDP GRO forwarding: $CURRENT_GRO"

if [[ "$CURRENT_GRO" == "on" ]]; then
    echo "âœ… Already optimized!"
    exit 0
fi

# Enable UDP GRO forwarding
echo "ðŸ”§ Enabling UDP GRO forwarding..."
if sudo ethtool -K "$PHYSICAL_IFACE" rx-udp-gro-forwarding on; then
    echo "âœ… UDP GRO forwarding enabled!"
else
    echo "âŒ Failed to enable UDP GRO forwarding"
    echo "   Your network driver may not support this feature"
    exit 1
fi

# Make persistent across reboots
UDEV_RULE="/etc/udev/rules.d/50-tailscale-gro.rules"
echo ""
echo "ðŸ’¾ Making setting persistent..."

sudo tee "$UDEV_RULE" > /dev/null << EOF
# Tailscale UDP GRO optimization
# Enables rx-udp-gro-forwarding for better WireGuard performance
ACTION=="add", SUBSYSTEM=="net", KERNEL=="$PHYSICAL_IFACE", RUN+="/usr/bin/ethtool -K $PHYSICAL_IFACE rx-udp-gro-forwarding on"
EOF

echo "âœ… Created udev rule: $UDEV_RULE"
echo ""
echo "ðŸš€ Network optimized for Tailscale!"
echo ""
echo "Verify with:"
echo "  ethtool -k $PHYSICAL_IFACE | grep rx-udp-gro-forwarding"
