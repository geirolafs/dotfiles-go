#!/usr/bin/env bash
# Advanced system tuning for VNC performance (run on iMac)
# WARNING: These are aggressive settings - revert after VNC session

set -euo pipefail

echo "üîß Applying BEAST MODE system tuning for VNC..."
echo ""

# Increase TCP buffer sizes for high-speed local network
echo "üì° Tuning TCP buffers for LAN speed..."
sudo sysctl -w net.core.rmem_max=16777216 2>/dev/null || echo "  (rmem_max tuning failed)"
sudo sysctl -w net.core.wmem_max=16777216 2>/dev/null || echo "  (wmem_max tuning failed)"
sudo sysctl -w net.ipv4.tcp_rmem='4096 87380 16777216' 2>/dev/null || echo "  (tcp_rmem tuning failed)"
sudo sysctl -w net.ipv4.tcp_wmem='4096 65536 16777216' 2>/dev/null || echo "  (tcp_wmem tuning failed)"

# Disable TCP slow start after idle
echo "‚ö° Disabling TCP slow start..."
sudo sysctl -w net.ipv4.tcp_slow_start_after_idle=0 2>/dev/null || echo "  (slow start tuning failed)"

# Reduce swappiness to keep VNC in RAM
echo "üíæ Reducing swappiness..."
sudo sysctl -w vm.swappiness=10 2>/dev/null || echo "  (swappiness tuning failed)"

# Set I/O scheduler to performance (if available)
echo "üíø Setting I/O scheduler..."
for disk in /sys/block/sd*/queue/scheduler /sys/block/nvme*/queue/scheduler; do
    if [[ -f "$disk" ]]; then
        echo "mq-deadline" | sudo tee "$disk" >/dev/null 2>&1 || true
    fi
done

# Disable desktop effects in Hyprland (if running)
if command -v hyprctl >/dev/null 2>&1; then
    echo "üé® Reducing Hyprland effects..."
    hyprctl keyword decoration:blur:enabled false 2>/dev/null || true
    hyprctl keyword decoration:drop_shadow false 2>/dev/null || true
    hyprctl keyword animations:enabled false 2>/dev/null || true
fi

echo ""
echo "‚úÖ BEAST MODE tuning applied!"
echo ""
echo "‚ö†Ô∏è  Remember to revert after VNC session:"
echo "  vnc-restore-system"
